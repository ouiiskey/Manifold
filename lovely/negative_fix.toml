[manifest]
version = "1.0.0"
dump_lua = true
priority = 0

# change_size
[[patches]]
[patches.pattern]
target = "cardarea.lua"
pattern = "local card_count = math.abs(delta)"
position = "at"
match_indent = true
payload = '''
local card_count = self.config.card_limit - #self.cards
'''

# set_edition
[[patches]]
[patches.pattern]
target = '=[SMODS _ "src/overrides.lua"]'
pattern = "if (self.added_to_deck or self.joker_added_to_deck_but_debuffed or (self.area == G.hand and not self.debuff)) and self.edition and self.edition.card_limit then"
position = "at"
match_indent = true
payload = '''
if not self.debuff and (self.added_to_deck or self.area == G.hand) and self.edition and self.edition.card_limit then
'''

[[patches]]
[patches.pattern]
target = '=[SMODS _ "src/overrides.lua"]'
pattern = "if (self.added_to_deck or self.joker_added_to_deck_but_debuffed or (self.area == G.hand and not self.debuff)) and G.jokers and G.consumeables then"
position = "at"
match_indent = true
payload = '''
if not self.debuff and (self.added_to_deck or self.area == G.hand) and G.jokers and G.consumeables then
'''

[[patches]]
[patches.pattern]
target = '=[SMODS _ "src/overrides.lua"]'
pattern = '''
if G.hand.config.real_card_limit then
    G.hand.config.real_card_limit = G.hand.config.real_card_limit + self.edition.card_limit
end
G.hand.config.card_limit = G.hand.config.card_limit + self.edition.card_limit
if not is_in_pack and G.GAME.blind.in_blind then
    G.FUNCS.draw_from_deck_to_hand(self.edition.card_limit)
end
'''
position = "at"
match_indent = true
payload = '''
G.hand:change_size(self.edition.card_limit)
'''

# set_debuff
[[patches]]
[patches.pattern]
target = "card.lua"
pattern = "if self.area == G.jokers then if should_debuff then self:remove_from_deck(true) else self:add_to_deck(true) end end"
position = "after"
match_indent = true
payload = '''
if self.area == G.hand then if self.debuff then G.hand:change_size(self.edition.card_limit) else G.hand:change_size(-self.edition.card_limit) end end
'''

# add_to_deck
[[patches]]
[patches.pattern]
target = "card.lua"
pattern = '''
if true then
    if from_debuff then
        self.joker_added_to_deck_but_debuffed = nil
    else
        if self.edition and self.edition.card_limit then
            if self.ability.consumeable then
                G.consumeables.config.card_limit = G.consumeables.config.card_limit + self.edition.card_limit
            else
                G.jokers.config.card_limit = G.jokers.config.card_limit + self.edition.card_limit
            end
        end
'''
position = "at"
match_indent = true
payload = '''
if self.edition and self.edition.card_limit and (from_debuff or not self.debuff) then
    print("debug3")
    if self.ability.consumeable then
        if self.config.center.set == "Planet" then
            G.planets.config.card_limit = G.planets.config.card_limit + self.edition.card_limit
        else
            G.consumeables.config.card_limit = G.consumeables.config.card_limit + self.edition.card_limit
        end
    elseif self.ability.set == "Joker" then
        G.jokers.config.card_limit = G.jokers.config.card_limit + self.edition.card_limit
'''

# remove_from_deck
[[patches]]
[patches.pattern]
target = "card.lua"
pattern = '''
if G.jokers then
    if from_debuff then
        self.joker_added_to_deck_but_debuffed = true
    else
        if self.edition and self.edition.card_limit then
            if self.ability.consumeable then
                G.consumeables.config.card_limit = G.consumeables.config.card_limit - self.edition.card_limit
            elseif self.ability.set == 'Joker' then
                G.jokers.config.card_limit = G.jokers.config.card_limit - self.edition.card_limit
            end
        end
'''
position = "at"
match_indent = true
payload = '''
print(self.edition)
if self.edition and self.edition.card_limit and G.jokers and (from_debuff or not self.debuff) then
    print("debug1")
    if self.ability.consumeable then
        if self.config.center.set == "Planet" then
            G.planets.config.card_limit = G.planets.config.card_limit - self.edition.card_limit
        else
            G.consumeables.config.card_limit = G.consumeables.config.card_limit - self.edition.card_limit
        end
    elseif self.ability.set == "Joker" then
        G.jokers.config.card_limit = G.jokers.config.card_limit - self.edition.card_limit
'''